<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; 
        style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; 
        font-src 'self' https://fonts.gstatic.com; 
        connect-src 'self' https://generativelanguage.googleapis.com;
        img-src 'self' data:;
    ">
    <title>Aura Interface | Single-Source Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/vibrant-ink.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <style>
        :root {
            --bg-dark-void: #0a0f18; --bg-panel: #121a2a; --border-glow: #00f6ff33;
            --accent-glow: #00f6ff; --text-primary: #e0e8f0; --text-secondary: #8a96a8;
            --font-main: 'Share Tech Mono', 'Fira Code', monospace; --accent-magenta: #ff2ea2;
        }
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; background-color: var(--bg-dark-void); color: var(--text-primary); height: 100vh; width: 100vw; display: flex; overflow: hidden; position: relative; }
        body::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, rgba(0, 246, 255, 0.03), rgba(0, 246, 255, 0.03) 1px, transparent 1px, transparent 4px), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2300f6ff' fill-opacity='0.05'%3E%3Cpath d='M0 38.59l2.83-2.83L0 32.93v5.66zm0-28.28l2.83-2.83L0 4.48v5.66zM3.54 0l2.83 2.83L10 0H3.54zM0 3.54L2.83 6.36 0 10V3.54zM3.54 40l2.83-2.83L10 40H3.54zM0 13.54l2.83 2.83L0 20v-6.46zM3.54 20l2.83 2.83L10 20H3.54zM0 23.54l2.83 2.83L0 30v-6.46z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); z-index: -1; pointer-events: none; }
        
        .split-view { width: 100%; height: 100%; display: flex; }
        
        /* Panel Links: Single Editor */
        .panel-editor { flex: 1; min-width: 400px; display: flex; flex-direction: column; background: var(--bg-panel); border-right: 1px solid var(--border-glow); }
        .editor-header { padding: 1rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); border-bottom: 1px solid var(--border-glow); }
        .CodeMirror { flex-grow: 1; font-family: var(--font-main) !important; font-size: 15px; height: calc(100% - 45px); }
        .cm-s-vibrant-ink.CodeMirror { background: transparent; }
        .cm-s-vibrant-ink .CodeMirror-gutters { background: #0000004d; border: none; }
        
        /* Panel Rechts: Vorschau & KI-Interaktion */
        .panel-interactive { flex: 1; min-width: 500px; display: flex; flex-direction: column; }
        
        .preview-pane { flex-grow: 2; border-bottom: 1px solid var(--border-glow); position: relative; }
        #output { width: 100%; height: 100%; border: none; background: white; }
        #highlight-overlay { position: absolute; background: #00f6ff33; border: 2px solid var(--accent-glow); z-index: 9999; pointer-events: none; transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .chat-pane { flex-grow: 1; padding: 1.5rem; display: flex; flex-direction: column; justify-content: flex-end; }
        .chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; }
        .chat-message { line-height: 1.6; margin-bottom: 1rem; }
        .chat-message.user .msg-content { color: var(--text-primary); }
        .chat-message.ai .msg-content { color: var(--accent-glow); }
        .chat-message.error .msg-content { color: var(--accent-magenta); }
        .chat-message strong { text-transform: uppercase; color: var(--text-secondary); }
        .blinking-cursor { animation: blink 1s step-end infinite; display: inline-block; width: 8px; height: 1.2em; background-color: var(--accent-glow); vertical-align: text-bottom; }
        @keyframes blink { 50% { opacity: 0; } }

        #context-info { padding: 10px; border: 1px solid var(--accent-magenta); color: var(--accent-magenta); display: none; margin-bottom: 1.5rem; }
        
        .chat-input-area { display: flex; gap: 1rem; }
        #api-key, #chat-input { background: transparent; border: 1px solid var(--border-glow); color: var(--text-primary); font-family: var(--font-main); font-size: 1rem; padding: 0.75rem; }
        #api-key { flex-basis: 150px; }
        #chat-input { flex-grow: 1; }
        #chat-input:focus, #api-key:focus { outline: 1px solid var(--accent-glow); }
        #chat-send { background: var(--bg-panel); border: 1px solid var(--accent-glow); color: var(--accent-glow); font-family: var(--font-main); cursor: pointer; padding: 0.75rem 1rem; transition: all 0.2s ease; }
        #chat-send:hover:not(:disabled) { background: var(--accent-glow); color: var(--bg-dark-void); text-shadow: 0 0 5px #000; }
        #chat-send:disabled { filter: grayscale(1); cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="split-view">
        <div class="panel panel-editor">
            <div class="editor-header">Source Code</div>
            <textarea id="code-editor"></textarea>
        </div>
        
        <div class="panel panel-interactive">
            <div class="preview-pane">
                <iframe id="output"></iframe>
            </div>
            <div class="chat-pane">
                <div class="chat-history" id="chat-history"></div>
                <div id="context-info">FOKUS: <span></span></div>
                <div class="chat-input-area">
                    <input id="api-key" type="password" placeholder="API Key...">
                    <input id="chat-input" type="text" placeholder="Deine Anweisung..." disabled>
                    <button id="chat-send" disabled>SEND</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dom = {
        chatHistory: document.getElementById('chat-history'),
        chatInput: document.getElementById('chat-input'),
        apiKeyInput: document.getElementById('api-key'),
        chatSendBtn: document.getElementById('chat-send'),
        contextInfo: document.getElementById('context-info'),
        outputFrame: document.getElementById('output'),
    };
    
    const state = { apiKey: '', chatHistory: [], selectedElement: null, isAwaitingAI: false };
    
    const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        lineNumbers: true,
        mode: 'htmlmixed',
        theme: 'vibrant-ink'
    });
    
    const initialCode = `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Aura Editor</title>
    <style>
        /* CSS hier schreiben */
        body {
            font-family: 'Share Tech Mono', monospace;
            display: grid; 
            place-items: center;
            height: 100vh; 
            margin: 0;
            background-color: #f0f4f9; 
            color: #333;
        }
        .content-box {
            text-align: center;
            padding: 2rem;
            background: #fff;
            border-radius: 10px;
        }
        .glow-button {
            padding: 1em 2em;
            border: none;
            font-weight: bold;
            color: white;
            background-color: #333;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }
        .glow-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    
    <div class="content-box">
      <h1>Aura Interface</h1>
      <p>Bearbeite HTML, CSS und JS in diesem Editor.</p>
      <button id="main-btn" class="glow-button">Initialisieren</button>
    </div>

    <script>
        // JavaScript hier schreiben
        const button = document.getElementById('main-btn');
        button.addEventListener('click', () => {
          button.textContent = 'SYSTEM AKTIV!';
          button.style.backgroundColor = '#28a745';
          button.style.boxShadow = '0 0 20px #28a745';
        });
    <\/script>
</body>
</html>`;
    editor.setValue(initialCode);

    function renderPreview() {
        dom.outputFrame.srcdoc = editor.getValue();
    }

    editor.on('change', renderPreview);

    function addMessageToChat(text, type, thinking=false) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${type}`;
        msgDiv.innerHTML = `<strong>${type.toUpperCase()}:</strong> <span class="msg-content">${text}${thinking ? '<span class="blinking-cursor"></span>' : ''}</span>`;
        dom.chatHistory.appendChild(msgDiv);
        dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
        return msgDiv;
    }
    
    function updateUIState() {
        dom.apiKeyInput.style.borderColor = state.apiKey ? 'var(--accent-glow)' : 'var(--border-glow)';
        dom.chatInput.disabled = !state.apiKey || state.isAwaitingAI;
        dom.chatSendBtn.disabled = !state.apiKey || state.isAwaitingAI;
    }
    
    async function handleChatSend() {
        const userPrompt = dom.chatInput.value.trim();
        if (!userPrompt) return;

        state.isAwaitingAI = true; updateUIState();
        addMessageToChat(userPrompt, 'user');
        const thinkingMsg = addMessageToChat("Analysiere...", 'ai', true);
        
        const contextPrompt = state.selectedElement ? `FOKUSSIERTES ELEMENT: Der Benutzer hat das Element ${state.selectedElement.selector} für diese Anfrage ausgewählt.` : '';
        const systemPrompt = `Du bist ein experter Web-Entwickler. Dir wird ein vollständiges HTML-Dokument zur Verfügung gestellt. Deine Aufgabe ist es, dieses Dokument basierend auf der Anfrage zu ändern. Du musst NUR ein valides JSON-Objekt zurückgeben, das exakt diesem Format folgt: { "newCode": "...", "explanation": "..." }. Der Wert für 'newCode' MUSS das VOLLSTÄNDIGE, aktualisierte HTML-Dokument als ein einziger String sein. 'explanation' MUSS eine kurze, freundliche Erklärung deiner Änderungen sein. Jede Antwort, die nicht diesem JSON-Format entspricht, ist ein Fehler.`;
        
        const historyForApi = state.chatHistory.concat({ role: 'user', parts: [{text: `${userPrompt}\n${contextPrompt}\n\nAKTUELLER CODE:\n${editor.getValue()}`}] });
        
        try {
            const model = 'gemini-1.5-flash-latest';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: historyForApi, systemInstruction: { parts: [{text: systemPrompt }] } }) });
            
            if (!response.ok) {
                let errorDetail = `Status: ${response.status}`;
                try { const errorData = await response.json(); if (errorData.error?.message) errorDetail = errorData.error.message; } catch(e){}
                throw new Error(errorDetail);
            }
            
            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            const cleanedText = rawText.replace(/^```json|```$/g, '').trim();
            let result;
            try {
                result = JSON.parse(cleanedText);
            } catch (parseError) {
                console.error("Ungültige Antwort der KI:", cleanedText);
                throw new Error("Antwort der KI konnte nicht verarbeitet werden. Bitte anders formulieren.");
            }

            thinkingMsg.remove();
            
            if (result.explanation) {
                addMessageToChat(result.explanation, 'ai');
                state.chatHistory.push({ role: 'user', parts: [{text: userPrompt}] }, { role: 'model', parts: [{text: result.explanation}] });
            }
            
            if (result.newCode) {
                editor.setValue(result.newCode); // Update single editor
            } else {
                 throw new Error("KI hat keinen neuen Code geliefert.");
            }
            
            dom.chatInput.value = '';

        } catch (error) {
            thinkingMsg.remove();
            addMessageToChat(`Fehler: ${error.message}`, 'error');
        } finally {
            state.isAwaitingAI = false; updateUIState();
        }
    }
    
    dom.apiKeyInput.addEventListener('input', () => { state.apiKey = dom.apiKeyInput.value.trim(); localStorage.setItem('auraSingleApiKey', state.apiKey); updateUIState(); });
    dom.chatSendBtn.addEventListener('click', handleChatSend);
    dom.chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); handleChatSend(); }});

    dom.outputFrame.addEventListener('load', () => {
        const doc = dom.outputFrame.contentDocument; if (!doc) return;
        doc.body.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation(); const target = e.target;
            let existingHighlight = doc.getElementById('highlight-overlay');
            if (!existingHighlight) {
                existingHighlight = doc.createElement('div'); existingHighlight.id = 'highlight-overlay';
                const style = doc.createElement('style'); style.innerHTML = `#highlight-overlay { position: absolute; pointer-events: none; background: #00f6ff33; border: 2px solid #00f6ff; z-index: 99999; transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); animation: fadeIn 0.3s forwards; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }`;
                doc.head.appendChild(style); doc.body.appendChild(existingHighlight);
            }
            const rect = target.getBoundingClientRect();
            existingHighlight.style.top = `${rect.top + doc.documentElement.scrollTop}px`;
            existingHighlight.style.left = `${rect.left + doc.documentElement.scrollLeft}px`;
            existingHighlight.style.width = `${rect.width}px`;
            existingHighlight.style.height = `${rect.height}px`;

            const tag = target.tagName.toLowerCase();
            const id = target.id ? `#${target.id}` : '';
            const classes = target.className ? `.${String(target.className).trim().replace(/\s+/g, '.')}` : '';
            state.selectedElement = { selector: `${tag}${id}${classes}` };
            dom.contextInfo.querySelector('span').textContent = state.selectedElement.selector;
            dom.contextInfo.style.display = 'block';
        }, true);
    });

    function init() {
        const savedKey = localStorage.getItem('auraSingleApiKey');
        if (savedKey) { dom.apiKeyInput.value = savedKey; state.apiKey = savedKey; }
        addMessageToChat('System bereit. API-Key eingeben, um zu starten.', 'ai');
        updateUIState(); renderPreview();
    }
    init();
});
</script>
</body>
</html>
