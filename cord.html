<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Studio Pro</title>

    <!-- CodeMirror-Bibliotheken für Syntax-Hervorhebung und Linting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/css-lint.min.js"></script>
    <script src="https://unpkg.com/jshint@2.13.6/dist/jshint.js"></script>
    <script src="https://unpkg.com/csslint@1.0.5/dist/csslint.js"></script>

    <style>
        :root {
            --bg-main: #f0f4f9;
            --bg-sidebar: #ffffff;
            --bg-editor: #212121;
            --bg-input: #f0f4f9;
            --border-color: #dbe1e8;
            --gutter-color: #e0e0e0;
            --text-primary: #1f2328;
            --text-secondary: #5f6368;
            --font-main: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'Fira Code', 'Roboto Mono', monospace;
            --accent-color: #1a73e8;
            --accent-color-hover: #1765cc;
            --shadow-light: 0 1px 2px rgba(0,0,0,0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Fira+Code&display=swap');

        /* --- Basis & Layout --- */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }
        .sidebar {
            width: 380px;
            flex-shrink: 0;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-light);
            z-index: 10;
            position: relative;
        }
        .main-content-wrapper { flex-grow: 1; display: flex; }
        .gutter { cursor: col-resize; background-color: var(--gutter-color); user-select: none; }
        .gutter-horizontal { cursor: row-resize; }
        
        /* --- Seitenleiste --- */
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 1.25rem; margin: 0; color: var(--text-primary); }
        .sidebar-header h1 span { color: var(--accent-color); }
        .sidebar-header p { font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0; }
        
        .sidebar-body { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        
        .api-key-section { margin-bottom: 1.5rem; }
        .api-key-section label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .api-key-input-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .api-key-input-wrapper input { flex-grow: 1; border: 1px solid var(--border-color); background-color: var(--bg-input); padding: 0.5rem 0.75rem; border-radius: 8px; font-family: var(--font-mono); font-size: 0.8rem; }
        .api-key-input-wrapper input:focus { outline: 2px solid var(--accent-color); }
        #api-key-status { font-size: 1.2rem; color: #34a853; transition: transform 0.2s; }

        /* Chat UI */
        .chat-history { flex-grow: 1; margin-bottom: 1rem; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 1rem; max-width: 95%; font-size: 0.95rem; line-height: 1.5; }
        .user-message { background-color: #e8f0fe; align-self: flex-end; }
        .ai-message { background-color: var(--bg-input); align-self: flex-start; }
        
        #selected-element-context {
            padding: 0.75rem; border: 1px dashed var(--accent-color); border-radius: 8px; margin: 0.5rem 0; font-size: 0.85rem;
            display: none; align-items: center; justify-content: space-between;
        }
        #selected-element-context button { background:none; border:none; cursor:pointer; font-size:1.5rem; color: var(--text-secondary); padding: 0 .5rem;}

        .chat-input-area { display: flex; gap: 0.5rem; margin-top: 1rem; }
        #chat-input { flex-grow: 1; resize: none; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); font-family: var(--font-main); }
        #chat-send { flex-shrink: 0; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; width: 44px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        #chat-send:disabled { background-color: #dbe1e8; cursor: not-allowed; }
        #chat-send:hover:not(:disabled) { background-color: var(--accent-color-hover); }
        
        /* --- Hauptinhalt (Editoren & Vorschau) --- */
        .editor-preview-split { display: flex; flex: 1; }
        .editor-column { flex: 1; display: flex; flex-direction: column; background: var(--bg-editor); }
        .editor-pane { display: flex; flex-direction: column; position: relative; height: calc(100% / 3); }
        .editor-pane-label { font-size: 0.8rem; font-weight: 500; color: #9e9e9e; padding: 0.5rem 1rem; background: #373737; font-family: var(--font-main); }
        .preview-column { flex: 1; background: white; }
        #output { width: 100%; height: 100%; border: none; }
        
        /* CodeMirror Theme & Anpassungen */
        .CodeMirror {
            font-family: var(--font-mono) !important;
            height: 100% !important;
            font-size: 14px;
            line-height: 1.6;
        }
        .cm-s-material-darker.CodeMirror { background: var(--bg-editor); }
        .cm-s-material-darker .CodeMirror-gutters { background: var(--bg-editor); border-right: 1px solid #373737;}

        /* --- Helfer-Klassen & Animationen --- */
        .loader-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast-Benachrichtigungen */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; border-radius: 8px; color: white; font-family: var(--font-main); box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: toast-in 0.3s ease-out forwards; display: flex; align-items: center; gap: 10px; }
        .toast.success { background-color: #34a853; }
        .toast.error { background-color: #ea4335; }
        @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <header class="sidebar-header">
            <h1>AI Studio <span>Pro</span></h1>
            <p>Interaktiver Code-Assistent</p>
        </header>

        <div class="sidebar-body">
             <div class="api-key-section">
                <label for="api-key">Gemini API-Schlüssel</label>
                <div class="api-key-input-wrapper">
                    <input type="password" id="api-key" placeholder="Wird automatisch gespeichert...">
                    <span id="api-key-status"></span>
                </div>
            </div>

            <div class="chat-history">
                <div class="ai-message">Willkommen! Klicke auf Elemente in der Vorschau, um sie gezielt zu ändern, oder gib einfach eine Anweisung.</div>
            </div>

            <div id="selected-element-context">
                <div><strong>Fokus:</strong> <code id="context-element-info"></code></div>
                <button id="clear-context-btn" title="Fokus aufheben">×</button>
            </div>
                
            <div class="chat-input-area">
                <textarea id="chat-input" rows="2" placeholder="z.B. Mache den Button rund..."></textarea>
                <button id="chat-send" title="Senden" disabled>
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <div class="gutter" id="sidebar-gutter" style="width: 5px;"></div>

    <main class="main-content-wrapper">
        <div class="editor-preview-split" id="editor-preview-split">
            <div class="editor-column" id="editor-column">
                <div class="editor-pane" id="html-pane">
                    <div class="editor-pane-label">HTML</div>
                    <textarea id="html-code"></textarea>
                </div>
                <div class="gutter gutter-horizontal" id="html-css-gutter" style="height: 5px;"></div>
                <div class="editor-pane" id="css-pane">
                    <div class="editor-pane-label">CSS</div>
                    <textarea id="css-code"></textarea>
                </div>
                <div class="gutter gutter-horizontal" id="css-js-gutter" style="height: 5px;"></div>
                <div class="editor-pane" id="js-pane">
                    <div class="editor-pane-label">JavaScript</div>
                    <textarea id="js-code"></textarea>
                </div>
            </div>
            <div class="gutter" id="editor-gutter" style="width: 5px;"></div>
            <div class="preview-column" id="preview-column">
                <iframe id="output"></iframe>
            </div>
        </div>
    </main>
    
    <div id="toast-container"></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE & ELEMENT-REFERENZEN ---
    const state = {
        apiKey: '',
        chatHistory: [{ role: 'model', parts: [{ text: "Hallo! Wie kann ich dir helfen, den Code zu gestalten?" }] }],
        selectedElement: null,
        isAwaitingAI: false,
    };
    
    const dom = {
        sidebar: document.getElementById('sidebar'),
        editorColumn: document.getElementById('editor-column'),
        previewColumn: document.getElementById('preview-column'),
        apiKeyInput: document.getElementById('api-key'),
        apiKeyStatus: document.getElementById('api-key-status'),
        chatHistory: document.querySelector('.chat-history'),
        chatInput: document.getElementById('chat-input'),
        chatSendBtn: document.getElementById('chat-send'),
        contextBox: document.getElementById('selected-element-context'),
        contextInfo: document.getElementById('context-element-info'),
        clearContextBtn: document.getElementById('clear-context-btn'),
        outputFrame: document.getElementById('output'),
        sendIcon: document.getElementById('send-icon'),
        htmlPane: document.getElementById('html-pane'),
        cssPane: document.getElementById('css-pane'),
        jsPane: document.getElementById('js-pane'),
    };
    
    // --- CODE-EDITOREN INITIALISIERUNG ---
    const createEditor = (id, mode) => {
        return CodeMirror.fromTextArea(document.getElementById(id), {
            lineNumbers: true,
            mode: mode,
            theme: 'material-darker',
            gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"],
            lint: true
        });
    };

    const editors = {
        html: createEditor('html-code', 'xml'),
        css: createEditor('css-code', 'css'),
        js: createEditor('js-code', 'javascript')
    };
    
    const initialCode = {
        html: `<div class="container">
  <h1>Willkommen im AI Studio!</h1>
  <p>Gib mir Anweisungen im Chat.</p>
  <button id="main-btn">Klick Mich</button>
</div>`,
        css: `body {
  background: linear-gradient(to right, #6dd5ed, #2193b0);
  font-family: 'Google Sans', sans-serif;
  display: grid;
  place-items: center;
  height: 100vh;
  margin: 0;
}
.container {
  background: rgba(255, 255, 255, 0.9);
  padding: 2rem 3rem;
  border-radius: 1rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  text-align: center;
}
button {
  background: #2193b0;
  color: white;
  border: none;
  padding: 0.8rem 1.6rem;
  font-size: 1rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}
button:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}`,
        js: `const button = document.getElementById('main-btn');
button.addEventListener('click', () => {
  alert('Du hast den Button geklickt!');
});`
    };
    
    editors.html.setValue(initialCode.html);
    editors.css.setValue(initialCode.css);
    editors.js.setValue(initialCode.js);

    // --- CORE-FUNKTIONALITÄT ---
    function renderPreview() {
        const source = `
            <html><head><style>${editors.css.getValue()}</style></head>
            <body>${editors.html.getValue()}<script>${editors.js.getValue()}<\/script></body></html>`;
        dom.outputFrame.srcdoc = source;
    }
    
    Object.values(editors).forEach(editor => editor.on('change', renderPreview));

    // --- DRAG-TO-RESIZE FUNKTIONALITÄT ---
    function makeResizable(gutterId, pane1Id, pane2Id, isHorizontal = false) {
        const gutter = document.getElementById(gutterId);
        const pane1 = document.getElementById(pane1Id);
        const pane2 = document.getElementById(pane2Id);
        
        gutter.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const startPos = isHorizontal ? e.clientY : e.clientX;
            const startPane1Size = isHorizontal ? pane1.offsetHeight : pane1.offsetWidth;
            const startPane2Size = isHorizontal ? pane2.offsetHeight : pane2.offsetWidth;
            
            const onMouseMove = (moveE) => {
                const delta = (isHorizontal ? moveE.clientY : moveE.clientX) - startPos;
                const totalSize = startPane1Size + startPane2Size;
                let pane1Size = startPane1Size + delta;
                let pane2Size = startPane2Size - delta;

                if (pane1Size < 50 || pane2Size < 50) return;
                
                pane1.style.flex = `${pane1Size}`;
                pane2.style.flex = `${pane2Size}`;
            };
            
            const onMouseUp = () => {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            };
            
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        });
    }

    makeResizable('sidebar-gutter', 'sidebar', 'main-content-wrapper');
    makeResizable('editor-gutter', 'editor-column', 'preview-column');
    makeResizable('html-css-gutter', 'html-pane', 'css-pane', true);
    makeResizable('css-js-gutter', 'css-pane', 'js-pane', true);

    // --- API & CHAT ---
    function updateUIState() {
        dom.apiKeyStatus.textContent = state.apiKey ? '✓' : '';
        dom.chatSendBtn.disabled = !state.apiKey || state.isAwaitingAI;
        dom.sendIcon.classList.toggle('loader-spinner', state.isAwaitingAI);
    }
    
    function addMessageToChat(text, sender) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${sender}-message`;
        msgDiv.textContent = text;
        dom.chatHistory.appendChild(msgDiv);
        dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
        return msgDiv;
    }

    async function handleChatSend() {
        const userPrompt = dom.chatInput.value.trim();
        if (!userPrompt || state.isAwaitingAI) return;
        
        state.isAwaitingAI = true;
        updateUIState();
        dom.chatInput.value = '';
        
        addMessageToChat(userPrompt, 'user');
        state.chatHistory.push({ role: 'user', parts: [{ text: userPrompt }] });

        let contextPrompt = '';
        if(state.selectedElement) {
            contextPrompt = `WICHTIG: Der Benutzer hat ein bestimmtes Element fokussiert: ${state.selectedElement.outerHTML}. Konzentriere dich auf dieses.`;
        }
        
        const systemPrompt = `Du bist ein experter Web-Entwickler-Assistent. Deine Aufgabe ist es, HTML-, CSS- und JS-Code basierend auf der Konversation zu ändern. Gib NUR ein rohes JSON-Objekt mit den Schlüsseln "html", "css", und "javascript" zurück, die den vollständigen, aktualisierten Code enthalten. Formatiere den Code sauber. Füge absolut keine Erklärungen oder Markdown (\`\`\`json) hinzu.`;

        // Die KI-Anfrage streamt jetzt die Antwort.
        try {
            const aiMessageDiv = addMessageToChat('...', 'ai');
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:streamGenerateContent?key=${state.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [...state.chatHistory, {role: "user", parts: [{text: `${systemPrompt}\n\n${contextPrompt}`}]}],
                    systemInstruction: { parts: [{text: systemPrompt }] }
                }),
            });

            if (!response.ok) throw new Error(`API Fehler ${response.status}`);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedJson = '';
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.includes('"text":')) {
                        const jsonPart = line.match(/"text":\s*"(.*)"/);
                        if(jsonPart && jsonPart[1]) {
                             accumulatedJson += JSON.parse(`"${jsonPart[1]}"`);
                        }
                    }
                }
                
                try {
                    let tempJson = accumulatedJson + '}';
                    // Korrigieren, falls mehrere schließende Klammern fehlen
                    while(tempJson.match(/{/g)?.length > tempJson.match(/}/g)?.length) {
                         tempJson += '}';
                    }
                    
                    const parsed = JSON.parse(tempJson);

                    if(parsed.html) editors.html.setValue(parsed.html);
                    if(parsed.css) editors.css.setValue(parsed.css);
                    if(parsed.js) editors.js.setValue(parsed.js);
                } catch(e) { /* Ungültiges JSON während des Streams ist normal */ }

            }
             aiMessageDiv.textContent = 'Code erfolgreich aktualisiert!'; // End-Nachricht

        } catch (error) {
            showToast(`Fehler: ${error.message}`, 'error');
        } finally {
            state.isAwaitingAI = false;
            updateUIState();
        }
    }
    
    dom.chatSendBtn.addEventListener('click', handleChatSend);
    dom.chatInput.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatSend(); }});

    // --- ELEMENT-INSPEKTOR & KONTEXT ---
    dom.outputFrame.addEventListener('load', () => {
        dom.outputFrame.contentDocument.body.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target;
            const tag = target.tagName.toLowerCase();
            const id = target.id ? `#${target.id}` : '';
            const classes = target.className ? `.${target.className.trim().replace(/\s+/g, '.')}` : '';
            const selector = `${tag}${id}${classes}`;

            state.selectedElement = { selector, outerHTML: target.outerHTML };
            dom.contextInfo.textContent = selector;
            dom.contextBox.style.display = 'flex';
        }, true);
    });

    dom.clearContextBtn.addEventListener('click', () => {
        state.selectedElement = null;
        dom.contextBox.style.display = 'none';
    });

    // --- Toast-Benachrichtigungen ---
    function showToast(message, type = 'success', duration = 4000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${type === 'success' ? '✓' : '✖'}</span> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    }
    
    // --- Initialisierung & Event Listener ---
    const savedApiKey = localStorage.getItem('geminiApiKeyPro');
    if(savedApiKey) {
        dom.apiKeyInput.value = savedApiKey;
        state.apiKey = savedApiKey;
    }
    dom.apiKeyInput.addEventListener('input', () => {
        state.apiKey = dom.apiKeyInput.value.trim();
        localStorage.setItem('geminiApiKeyPro', state.apiKey);
        updateUIState();
    });

    updateUIState();
    renderPreview();
    
    // Editor neu zeichnen, wenn die Größe geändert wird, um Darstellungsfehler zu vermeiden
    ['sidebar-gutter', 'editor-gutter', 'html-css-gutter', 'css-js-gutter'].forEach(id => {
        document.getElementById(id).addEventListener('mousedown', () => {
            const onMouseUp = () => {
                Object.values(editors).forEach(editor => editor.refresh());
                window.removeEventListener('mouseup', onMouseUp);
            }
            window.addEventListener('mouseup', onMouseUp);
        });
    });

});
</script>

</body>
</html>
