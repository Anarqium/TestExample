<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; 
        style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; 
        font-src 'self' https://fonts.gstatic.com; 
        connect-src 'self' https://generativelanguage.googleapis.com;
        img-src 'self' data:;
    ">
    <title>Aura Command Center | AI Live Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/vibrant-ink.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <style>
        :root {
            --bg-dark-void: #0a0f18; --bg-panel: #121a2a; --border-glow: #00f6ff33;
            --accent-glow: #00f6ff; --text-primary: #e0e8f0; --text-secondary: #8a96a8;
            --font-main: 'Share Tech Mono', 'Fira Code', monospace; --accent-magenta: #ff2ea2;
        }
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; background-color: var(--bg-dark-void); color: var(--text-primary); height: 100vh; width: 100vw; display: flex; overflow: hidden; position: relative; }
        body::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, rgba(0, 246, 255, 0.03), rgba(0, 246, 255, 0.03) 1px, transparent 1px, transparent 4px), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2300f6ff' fill-opacity='0.05'%3E%3Cpath d='M0 38.59l2.83-2.83L0 32.93v5.66zm0-28.28l2.83-2.83L0 4.48v5.66zM3.54 0l2.83 2.83L10 0H3.54zM0 3.54L2.83 6.36 0 10V3.54zM3.54 40l2.83-2.83L10 40H3.54zM0 13.54l2.83 2.83L0 20v-6.46zM3.54 20l2.83 2.83L10 20H3.54zM0 23.54l2.83 2.83L0 30v-6.46z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); z-index: -1; pointer-events: none; }
        
        .split-view { width: 100%; height: 100%; display: flex; }
        .gutter { cursor: col-resize; background: var(--border-glow); }
        .gutter-horizontal { cursor: row-resize; }

        /* Panel Links: Kommandozentrale (Code + Chat) */
        .panel-left { flex: 1; min-width: 500px; display: flex; flex-direction: column; }
        
        .editor-pane { flex: 2; display: flex; flex-direction: column; background: var(--bg-panel); }
        .editor-header { padding: 0.75rem 1.5rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); border-bottom: 1px solid var(--border-glow); }
        .CodeMirror { flex-grow: 1; font-family: var(--font-main) !important; font-size: 15px; height: calc(100% - 40px); }
        .cm-s-vibrant-ink.CodeMirror { background: transparent; }
        .cm-s-vibrant-ink .CodeMirror-gutters { background: #0000004d; border: none; }
        
        .chat-pane { flex: 1; min-height: 250px; padding: 1.5rem; display: flex; flex-direction: column; justify-content: flex-end; background: var(--bg-panel); }
        .chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; }
        .chat-message { line-height: 1.6; margin-bottom: 1rem; }
        .chat-message.user .msg-content { color: var(--text-primary); }
        .chat-message.ai .msg-content { color: var(--accent-glow); }
        .chat-message.error .msg-content { color: var(--accent-magenta); }
        .chat-message strong { text-transform: uppercase; color: var(--text-secondary); }
        .blinking-cursor { animation: blink 1s step-end infinite; display: inline-block; width: 8px; height: 1.2em; background-color: var(--accent-glow); vertical-align: text-bottom; }
        @keyframes blink { 50% { opacity: 0; } }
        #context-info { padding: 10px; border: 1px solid var(--accent-magenta); color: var(--accent-magenta); display: none; margin-bottom: 1.5rem; }
        
        .chat-input-area { display: flex; gap: 1rem; }
        #api-key, #chat-input { background: transparent; border: 1px solid var(--border-glow); color: var(--text-primary); font-family: var(--font-main); font-size: 1rem; padding: 0.75rem; }
        #api-key { flex-basis: 150px; }
        #chat-input { flex-grow: 1; }
        #chat-input:focus, #api-key:focus { outline: 1px solid var(--accent-glow); }
        #chat-send { background: var(--bg-panel); border: 1px solid var(--accent-glow); color: var(--accent-glow); font-family: var(--font-main); cursor: pointer; padding: 0.75rem 1rem; transition: all 0.2s ease; }
        #chat-send:hover:not(:disabled) { background: var(--accent-glow); color: var(--bg-dark-void); }
        #chat-send:disabled { filter: grayscale(1); cursor: not-allowed; }
        
        /* Panel Rechts: Vorschau */
        .panel-right { flex: 1; min-width: 400px; display: flex; flex-direction: column; }
        .preview-header { padding: 0.75rem 1.5rem; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-glow); background: #0000004d;}
        
        /* Auswählmodus Schalter */
        .toggle-switch { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .toggle-switch input { height: 0; width: 0; visibility: hidden; }
        .toggle-switch label { cursor: pointer; text-indent: -9999px; width: 50px; height: 25px; background: var(--text-secondary); display: block; border-radius: 100px; position: relative; }
        .toggle-switch label:after { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: #fff; border-radius: 21px; transition: 0.3s; }
        .toggle-switch input:checked + label { background: var(--accent-glow); }
        .toggle-switch input:checked + label:after { left: calc(100% - 2px); transform: translateX(-100%); }

        .preview-body { flex-grow: 1; position: relative; }
        #output { width: 100%; height: 100%; border: none; background: white; transition: cursor 0.3s; }
        .inspect-mode #output { cursor: crosshair; }

        #highlight-overlay { position: absolute; background: #00f6ff33; border: 2px solid var(--accent-glow); z-index: 9999; pointer-events: none; transition: all 0.2s; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div class="split-view">
        <div class="panel panel-left" id="panel-left">
            <div class="editor-pane" id="editor-pane">
                <div class="editor-header">Source Code</div>
                <textarea id="code-editor"></textarea>
            </div>
            <div class="gutter gutter-horizontal" id="editor-chat-gutter" style="height: 5px; background: var(--border-glow);"></div>
            <div class="chat-pane" id="chat-pane">
                <div class="chat-history" id="chat-history"></div>
                <div id="context-info">FOKUS: <span></span></div>
                <div class="chat-input-area">
                    <input id="api-key" type="password" placeholder="API Key...">
                    <input id="chat-input" type="text" placeholder="Deine Anweisung..." disabled>
                    <button id="chat-send" disabled>SEND</button>
                </div>
            </div>
        </div>
        <div class="gutter" id="main-gutter" style="width: 5px; background: var(--border-glow);"></div>
        <div class="panel panel-right" id="panel-right">
            <div class="preview-header">
                <div class="toggle-switch">
                    <span>Auswählmodus</span>
                    <input type="checkbox" id="inspect-mode-toggle"/>
                    <label for="inspect-mode-toggle">Toggle</label>
                </div>
            </div>
            <div class="preview-body">
                <iframe id="output"></iframe>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dom = {
        chatHistory: document.getElementById('chat-history'),
        chatInput: document.getElementById('chat-input'),
        apiKeyInput: document.getElementById('api-key'),
        chatSendBtn: document.getElementById('chat-send'),
        contextInfo: document.getElementById('context-info'),
        outputFrame: document.getElementById('output'),
        inspectModeToggle: document.getElementById('inspect-mode-toggle'),
        previewBody: document.querySelector('.preview-body'),
    };
    
    const state = { apiKey: '', chatHistory: [], selectedElement: null, isAwaitingAI: false, isInspectModeActive: false };
    
    const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), { lineNumbers: true, mode: 'htmlmixed', theme: 'vibrant-ink' });
    
    const initialCode = `<!DOCTYPE html>\n<html lang="de">\n<head>\n    <meta charset="UTF-8">\n    <title>Aura Editor</title>\n    <style>\n        /* CSS hier schreiben */\n        body {\n            font-family: 'Share Tech Mono', monospace;\n            display: grid; \n            place-items: center;\n            height: 100vh; \n            margin: 0;\n            background-color: #f0f4f9; \n            color: #333;\n        }\n        .content-box {\n            text-align: center;\n            padding: 2rem;\n            background: #fff;\n            border-radius: 10px;\n            box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n        }\n        button {\n            padding: 1em 2em;\n            border: none;\n            font-weight: bold;\n            color: white;\n            background-color: #333;\n            cursor: pointer;\n            transition: all 0.3s ease-in-out;\n        }\n        button:hover {\n            transform: scale(1.1);\n            box-shadow: 0 0 15px #333;\n        }\n    </style>\n</head>\n<body>\n    \n    <div class="content-box">\n      <h1>Aura Command Center</h1>\n      <p>Benutze den Schalter oben rechts, um Elemente auszuwählen.</p>\n      <button id="main-btn">Klick Mich!</button>\n    </div>\n\n    <script>\n        // JavaScript hier schreiben\n        const button = document.getElementById('main-btn');\n        button.addEventListener('click', () => {\n          alert('Button geklickt! Schalte den Auswählmodus an, um ihn mit der KI zu bearbeiten.');\n        });\n    <\/script>\n</body>\n</html>`;
    editor.setValue(initialCode);

    function renderPreview() {
        dom.outputFrame.srcdoc = editor.getValue();
    }
    editor.on('change', renderPreview);

    function addMessageToChat(text, type, thinking=false) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${type}`;
        msgDiv.innerHTML = `<strong>${type.toUpperCase()}:</strong> <span class="msg-content">${text}${thinking ? '<span class="blinking-cursor"></span>' : ''}</span>`;
        dom.chatHistory.appendChild(msgDiv);
        dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
        return msgDiv;
    }
    
    function updateUIState() {
        dom.apiKeyInput.style.borderColor = state.apiKey ? 'var(--accent-glow)' : 'var(--border-glow)';
        dom.chatInput.disabled = !state.apiKey || state.isAwaitingAI;
        dom.chatSendBtn.disabled = !state.apiKey || state.isAwaitingAI;
        dom.previewBody.classList.toggle('inspect-mode', state.isInspectModeActive);
    }
    
    async function handleChatSend() {
        const userPrompt = dom.chatInput.value.trim(); if (!userPrompt) return;
        state.isAwaitingAI = true; updateUIState();
        addMessageToChat(userPrompt, 'user');
        const thinkingMsg = addMessageToChat("Analysiere...", 'ai', true);
        
        const contextPrompt = state.selectedElement ? `FOKUSSIERTES ELEMENT: Der Benutzer hat das Element ${state.selectedElement.selector} für diese Anfrage ausgewählt.` : '';
        const systemPrompt = `Du bist ein experter Web-Entwickler. Dir wird ein vollständiges HTML-Dokument zur Verfügung gestellt. Deine Aufgabe ist es, dieses Dokument basierend auf der Anfrage zu ändern. Du musst NUR ein valides JSON-Objekt zurückgeben, das exakt diesem Format folgt: { "newCode": "...", "explanation": "..." }. Der Wert für 'newCode' MUSS das VOLLSTÄNDIGE, aktualisierte HTML-Dokument als ein einziger String sein. 'explanation' MUSS eine kurze, freundliche Erklärung deiner Änderungen sein. Jede Antwort, die nicht diesem JSON-Format entspricht, ist ein Fehler.`;
        
        const historyForApi = state.chatHistory.concat({ role: 'user', parts: [{text: `${userPrompt}\n${contextPrompt}\n\nAKTUELLER CODE:\n${editor.getValue()}`}] });
        
        try {
            const model = 'gemini-1.5-flash-latest'; const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: historyForApi, systemInstruction: { parts: [{text: systemPrompt }] } }) });
            if (!response.ok) {
                let errorDetail = `Status: ${response.status}`;
                try { const errorData = await response.json(); if (errorData.error?.message) errorDetail = errorData.error.message; } catch(e){}
                throw new Error(errorDetail);
            }
            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const cleanedText = rawText.replace(/^```json|```$/g, '').trim();
            let result;
            try { result = JSON.parse(cleanedText); } catch (e) {
                console.error("Ungültige Antwort der KI:", cleanedText); throw new Error("Antwort der KI konnte nicht verarbeitet werden. Bitte anders formulieren.");
            }

            thinkingMsg.remove();
            if (result.explanation) {
                addMessageToChat(result.explanation, 'ai');
                state.chatHistory.push({ role: 'user', parts: [{text: userPrompt}] }, { role: 'model', parts: [{text: result.explanation}] });
            }
            if (result.newCode) { editor.setValue(result.newCode); } else { throw new Error("KI hat keinen neuen Code geliefert."); }
            dom.chatInput.value = '';

        } catch (error) {
            thinkingMsg.remove(); addMessageToChat(`Fehler: ${error.message}`, 'error');
        } finally {
            state.isAwaitingAI = false; updateUIState();
        }
    }
    
    // Resizable Panes
    function makeResizable(gutterId, pane1Id, pane2Id, isHorizontal = false) {
        const gutter = document.getElementById(gutterId), pane1 = document.getElementById(pane1Id), pane2 = document.getElementById(pane2Id);
        gutter.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const startPos = isHorizontal ? e.clientY : e.clientX, p1_start = isHorizontal ? pane1.offsetHeight : pane1.offsetWidth, p2_start = isHorizontal ? pane2.offsetHeight : pane2.offsetWidth;
            const onMouseMove = (moveE) => {
                const delta = (isHorizontal ? moveE.clientY : moveE.clientX) - startPos;
                pane1.style.flex = `0 0 ${p1_start + delta}px`; pane2.style.flex = `1 1 auto`;
                editor.refresh();
            };
            const onMouseUp = () => { window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); };
            window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp);
        });
    }
    makeResizable('main-gutter', 'panel-left', 'panel-right');
    makeResizable('editor-chat-gutter', 'editor-pane', 'chat-pane', true);
    
    dom.apiKeyInput.addEventListener('input', () => { state.apiKey = dom.apiKeyInput.value.trim(); localStorage.setItem('auraCmdApiKey', state.apiKey); updateUIState(); });
    dom.chatSendBtn.addEventListener('click', handleChatSend);
    dom.chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); handleChatSend(); }});
    dom.inspectModeToggle.addEventListener('change', (e) => { state.isInspectModeActive = e.target.checked; updateUIState(); });
    
    dom.outputFrame.addEventListener('load', () => {
        const doc = dom.outputFrame.contentDocument; if (!doc) return;
        doc.body.addEventListener('click', (e) => {
            if (!state.isInspectModeActive) return; // Hier ist die Kernlogik des Auswählmodus
            e.preventDefault(); e.stopPropagation(); const target = e.target;
            
            let existingHighlight = doc.getElementById('highlight-overlay');
            if (!existingHighlight) {
                existingHighlight = doc.createElement('div'); existingHighlight.id = 'highlight-overlay';
                const style = doc.createElement('style'); style.innerHTML = `#highlight-overlay { position: absolute; pointer-events: none; background: #00f6ff33; border: 2px solid #00f6ff; z-index: 99999; transition: all 0.2s; animation: fadeIn 0.3s; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }`;
                doc.head.appendChild(style); doc.body.appendChild(existingHighlight);
            }
            const rect = target.getBoundingClientRect();
            existingHighlight.style.cssText = `top:${rect.top + doc.documentElement.scrollTop}px; left:${rect.left + doc.documentElement.scrollLeft}px; width:${rect.width}px; height:${rect.height}px;`;
            
            const tag = target.tagName.toLowerCase(), id = target.id ? `#${target.id}` : '', classes = target.className ? `.${String(target.className).trim().replace(/\s+/g, '.')}` : '';
            state.selectedElement = { selector: `${tag}${id}${classes}` };
            dom.contextInfo.querySelector('span').textContent = state.selectedElement.selector;
            dom.contextInfo.style.display = 'block';
        }, true);
    });

    function init() {
        const savedKey = localStorage.getItem('auraCmdApiKey');
        if (savedKey) { dom.apiKeyInput.value = savedKey; state.apiKey = savedKey; }
        addMessageToChat('System bereit. API-Key eingeben. "Auswählmodus" aktivieren, um Elemente zu fokussieren.', 'ai');
        updateUIState(); renderPreview();
    }
    init();
});
</script>
</body>
</html>
